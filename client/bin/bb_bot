#!/usr/bin/env ruby

require 'socket'

require_relative '../lib/bomberboys_client'
include BomberboysClient

n_bots      = (ARGV.shift || 1).to_i
trash       = (ARGV.shift || 0).to_i
socket_type = (ARGV.shift || :tcp).to_sym
address     = (ARGV.shift || 'localhost')
port        = (ARGV.shift || 10011).to_i

puts "Usage (all optional params): bb_bot n_bots trash_size [tcp|udp] address port\n"

clients = []
n_bots.times do
  begin
    if socket_type == :udp
      socket = UDPSocket.new
      socket.connect(address, port)
    else
      socket = TCPSocket.open(address, port)
    end
  rescue
    raise "No server listening on #{address}:#{port}"
  end

  name = "not_a_bot_#{(rand*10000000000).to_i}"
  clients << Client.new(RandomBot.new(ServerInterface.new(socket, trash), name))
end

Thread.abort_on_exception = true

clients.map(&:connect)
clients.map(&:start)

Thread.new do
  loop do
    sleep(5)
    clients.each { |c| c.ack }
    clients.first.ping
  end
end

puts "#{n_bots} bot(s). Each one connected with server on #{address}:#{port} (#{socket_type})"

clients.map(&:join)
